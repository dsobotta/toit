# Compiling for RISC-V

How to compile  and run Toit on a SiFive Unmatched dev board or RISC-V VM with QEMU. 

| STATUS | |
| ------------- | ------------- |
| ![](https://img.shields.io/static/v1?label=&message=SUCCESS&color=green) | Linux RISC-V environment |
| ![](https://img.shields.io/static/v1?label=&message=SUCCESS&color=green) | IDF environment |
| ![](https://img.shields.io/static/v1?label=&message=SUCCESS&color=green) | IDF compile sources |
| ![](https://img.shields.io/static/v1?label=&message=FAILURE&color=red) | IDF export > [doesn't compile on RISC-V host](https://github.com/dsobotta/toit-riscv/issues/4) |
| ![](https://img.shields.io/static/v1?label=&message=SUCCESS&color=green)| Toit generate build files |
| ![](https://img.shields.io/static/v1?label=&message=SUCCESS&color=green) | Toit compile sources |
| ![](https://img.shields.io/static/v1?label=&message=SUCCESS&color=green)| Toit generate boot snapshot |
| ![](https://img.shields.io/static/v1?label=&message=SUCCESS&color=green) | Toit run examples |
| ![](https://img.shields.io/static/v1?label=&message=PARTIAL&color=yellow) | Cross-compile for RISC-V > [fails to link on Arch](https://github.com/dsobotta/toit-riscv/issues/6)|
| ![](https://img.shields.io/static/v1?label=&message=TODO&color=orange) | Embedded RISC-V support |


## 1) RISC-V Environment Setup
Install a Debian-based Linux distro (choose one)
- SiFive Unmatched: [Ubuntu Server 20.04](https://ubuntu.com/tutorials/how-to-install-ubuntu-on-risc-v-hifive-boards#1-overview)
- Virtual Machine: [RISC-V VM with QEMU](https://colatkinson.site/linux/riscv/2021/01/27/riscv-qemu/)

## 2) Install Dependencies
``` sh
apt update
apt install git build-essential bc cmake python3 python3-pip python-is-python3 libffi-dev libssl-dev cargo golang ninja-build
```

## 3) Clone Sources 
``` sh
#ESP-IDF
git clone https://github.com/dsobotta/esp-idf-riscv.git
pushd esp-idf-riscv/
git checkout patch-head-4.3-3
git submodule update --init --recursive
popd

#Toit
git clone https://github.com/dsobotta/toit-riscv.git

#Add IDF path to environment
export IDF_PATH=PATH_TO_ESP_IDF_RISCV
```

## 4) Compile Toit
``` sh
cd toit-riscv
make tools
```

## 5) Run Examples
``` sh
build/host/bin/toitvm examples/hello.toit
build/host/bin/toitvm examples/bubble_sort.toit
build/host/bin/toitvm examples/http.toit
build/host/bin/toitvm examples/mandelbrot.toit
```
</br>
</br>

# Cross-Compiling for RISC-V/Linux

How to compile the 64-bit RISC-V Toit binaries (toitc and toitvm) from another architecture (ie. amd64)
> *Note: [Fails to link on Arch](https://github.com/dsobotta/toit-riscv/issues/6)* 

## 1) Compile host tools
> *Note: This is a necessary to generate toitvm_boot.snapshot, a dependency for the toitvm runtime.* </br> 
Follow [steps 2-4 above](https://github.com/dsobotta/toit-riscv#2-install-dependencies), on the non-riscv64 host.

## 2) Install dependencies
``` sh
apt update
apt install gcc-riscv64-linux-gnu g++-riscv64-linux-gnu
```

## 3) Cross-compile 64-bit RISC-V Toit
``` sh
cd toit-riscv
make tools-riscv64
```

> Note: the build will fail here when trying to generate the toitvm_boot.snapshot.  This is because the build scripts attempt to run build/riscv64/bin/toitc (a 64-bit RISC-V binary) on a non-riscv64 host.
``` sh
...
[322/322] Generating ../bin/toitvm_boot.snapshot
FAILED: bin/toitvm_boot.snapshot 
cd /root/git/toit-riscv/build/riscv64/src && /usr/bin/cmake -E env ASAN_OPTIONS=detect_leaks=false ASAN_OPTIONS=detect_leaks=false /root/git/toit-riscv/build/riscv64/bin/toitc --dependency-file /root/git/toit-riscv/build/riscv64/src/boot.dep --dependency-format ninja -w /root/git/toit-riscv/build/riscv64/bin/toitvm_boot.snapshot /root/git/toit-riscv/tools/toitvm_boot.toit
/root/git/toit-riscv/build/riscv64/bin/toitc: 1: ELF�X�@8: not found
/root/git/toit-riscv/build/riscv64/bin/toitc: 1: Syntax error: "&" unexpected
ninja: build stopped: subcommand failed.
make: *** [Makefile:38: build/riscv64/bin/toitvm] Error 1
```
</br>

So we'll complete the process by copying the snapshot generated by the host environment: 
``` sh
cp build/host/bin/toitvm_boot.snapshot build/riscv64/bin/
```

## 4) Deploy
A complete Toit environment should now be ready for use on 64-bit RISC-V hardware
``` sh
ubuntu@ubuntu:~/git/toit-riscv$ ls -l build/riscv64/bin/
total 4112
lrwxrwxrwx 1 ubuntu ubuntu      31 Dec  4 07:48 lib -> /home/ubuntu/git/toit-riscv/lib
drwxrwxr-x 7 ubuntu ubuntu    4096 Dec  4 11:19 mbedtls
-rwxrwxr-x 1 ubuntu ubuntu 1806496 Dec  4 07:49 toitc
-rwxrwxr-x 1 ubuntu ubuntu 2189584 Dec  4 07:49 toitvm
-rw-rw-r-- 1 ubuntu ubuntu  202320 Dec  4 11:19 toitvm_boot.snapshot
```
</br>
</br>

